SRC_PREFIX = "sqlite-src-3081101"

cc_binary(
    name = "lemon",
    srcs = ["%s/tool/lemon.c" % SRC_PREFIX],
)

COMPILER_OPTS = [
    "-DNDEBUG=1",
    "-DHAVE_FDATASYNC=1",
]

genrule(
    name = "generate_parse_source",
    tools = [":lemon"],
    outs = ["%s/src/parse.c" % SRC_PREFIX, "%s/src/parse.h" % SRC_PREFIX],
    srcs = [
        "%s/src/parse.y" % SRC_PREFIX,
        "%s/src/lempar.c" % SRC_PREFIX,
	"%s/addopcodes.awk" % SRC_PREFIX,
    ],
    cmd = ("TMPDIR=$$(mktemp -d) && mkdir -p $(@D)/%s/src &&" % (SRC_PREFIX,) +
        "cp $(location :lemon) $(location :%s/src/lempar.c) " % (SRC_PREFIX,) +
        "$(location :%s/src/parse.y) $$TMPDIR/ &&" % (SRC_PREFIX,) +
        "(cd $$TMPDIR && ./lemon parse.y) && " +
        "cp $$TMPDIR/parse.c $(location :%s/src/parse.c) &&" % (SRC_PREFIX,) +
        "awk -f $(location :%s/addopcodes.awk) $$TMPDIR/parse.h " % (SRC_PREFIX,) +
        "> $(location :%s/src/parse.h) &&" % (SRC_PREFIX,) +
        "rm -rf $$TMPDIR"
    )
)

genrule(
    name = "generate_sqlite3.h",
    srcs = [ "%s/%s" % (SRC_PREFIX, src) for src in [
        "src/sqlite.h.in",
	"manifest.uuid",
	"VERSION",
	"ext/rtree/sqlite3rtree.h",
	"tool/mksqlite3h.tcl"
    ]],
    outs = ["%s/src/sqlite3.h" % (SRC_PREFIX,)],
    cmd = ("tclsh $(location :%s/tool/mksqlite3h.tcl) $$(dirname $(location :%s/VERSION)) " % (SRC_PREFIX, SRC_PREFIX,) +
        "> $(location :%s/src/sqlite3.h)" % (SRC_PREFIX,)),
)

cc_binary(
    name = "mkkeywordhash",
    srcs = ["%s/tool/mkkeywordhash.c" % (SRC_PREFIX,)],
)
    
genrule(
    name = "generate_keywordhash.h",
    tools = [":mkkeywordhash"],
    outs = ["%s/src/keywordhash.h" % (SRC_PREFIX,)],
    cmd = "$(location :mkkeywordhash) > $(location :%s/src/keywordhash.h)" % (SRC_PREFIX,),
)

genrule(
    name = "generate_opcodes_source",
    outs = [
        "%s/src/opcodes.c" % (SRC_PREFIX,),
        "%s/src/opcodes.h" % (SRC_PREFIX,),
    ],
    srcs = [
        "%s/src/parse.h" % (SRC_PREFIX,),
	"%s/src/vdbe.c" % (SRC_PREFIX,),
	"%s/mkopcodeh.awk" % (SRC_PREFIX,),
	"%s/mkopcodec.awk" % (SRC_PREFIX,),
    ],
    cmd = "cat $(location %s/src/parse.h) " % (SRC_PREFIX,) +
      "$(location %s/src/vdbe.c) " % (SRC_PREFIX,) +
      "| awk -f $(location %s/mkopcodeh.awk) " % (SRC_PREFIX,) +
      "> $(location %s/src/opcodes.h) && "  % (SRC_PREFIX,) +
      "awk -f $(location %s/mkopcodec.awk) " % (SRC_PREFIX,) +
      "$(location %s/src/opcodes.h) "  % (SRC_PREFIX,) +
      "> $(location %s/src/opcodes.c)" % (SRC_PREFIX,)
)

cc_library(
    name = "sqlite3",
    hdrs = ["src/sqlite3.h"],
    srcs = glob(
        ["**/*.c", "**/*.h"],
        #["src/*.h", "src/*.c, ext/**/*.c", "ext/**/*.h"],
        exclude = ["%s/%s" % (SRC_PREFIX, src) for src in [
            "autoconf/**",
	    "ext/fts1/**",
	    "ext/fts2/**",
            "ext/misc/**",
            "src/lempar.c",
            "src/tclsqlite.c",
            "src/sqlite3ext.h",
	    "**/*test*.c",
            "test/**",
            "**/tool/**",
	]]) + ["%s/%s" % (SRC_PREFIX, src) for src in [
        "src/keywordhash.h",
        ":generate_sqlite3.h",
        #"src/parse.c",
        #"src/parse.h",
        "src/opcodes.c",
        "src/opcodes.h"]],
    includes = ["%s/src/" % (SRC_PREFIX,)],
    copts = ["-DSQLITE_CORE"] + COMPILER_OPTS,
)
